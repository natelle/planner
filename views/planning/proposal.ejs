<%- include ../header.ejs %>

<h2><%= __("planning.proposal") %></h2>
<br>
<br>
<p class="text-right">
    <a class="btn btn-primary" href="/planning/<%= planning.id %>/validate"><%= __('planning.validate') %></a>
</p>
<br>
<table class="table table-sm">
    <thead class="thead-dark">
        <tr>
            <th scope="col"><%= __("planning.date") %></th>
            <th scope="col" class="text-center"><%= __("planning.slot") %></th>
        </tr>
    </thead>
    <tbody>
        <% var availabilityDateId = (planning.firstDate.getMonth()+1).toString().padStart(2, '0') + planning.firstDate.getFullYear() %>
        <% for(var d=planning.firstDate; d<=planning.lastDate; d.setDate(d.getDate() + 1)) { %>
            <% var dateId = d.getFullYear() + '-' + (d.getMonth()+1).toString().padStart(2, '0') + '-' + d.getDate().toString().padStart(2, '0') %>
            <tr class="availability">
            <th scope="row" class="date">
            <%= d.getDate().toString().padStart(2, '0') + '/' + (d.getMonth()+1).toString().padStart(2, '0') + '/' + d.getFullYear() %>
            </th>
            <td class="text-center">
            <div class="card-deck">
            <% var dayPresences = planning.presences[d] %>
            <% if(Object.keys(dayPresences).length > 0 ) { %>
                <% for(var slot of slots) { %>
                    <% if(slot.days.includes(d.getDay())) { %>
                        <% var slotPresences = dayPresences[slot.id] %>
                        <% if(typeof slotPresences !== 'undefined') { %>
                            <div class="card" data-slotId="<%= slot.id %>" data-dateId="<%= dateId %>" presenceId="">
                            <div class="card-header py-1">
                            <%= slotPresences[0].slot.name %> (<%= slotPresences.length %>)
                            <a href="#add-employee" class="float-right add-employee"><i class="fas fa-pencil-alt"></i></a>
                            </div>
                            <div class="card-body py-1">
                            <% for(var presence of slotPresences) { %>
                                <p class="card-text mb-1 employee" data-employeeId="<%= presence.Employee.id %>">
                                <a href="/employee/<%= presence.Employee.id %>/availabilities/<%= availabilityDateId %>">
                                <small><%= presence.Employee.getName() %></small><!-- TODO: add button to replace the person -->
                                </a>
                                </p>
                                <% } %>
                                </div>
                                </div>
                                <% } else { %>
                                    <div class="card invisible"></div>
                                    <% } %>
                                    <% }} %>
                                    <% } else { %>
                                        <button class="btn btn-secondary disabled mx-auto"><%= __("time.closed") %></button>
                                        <% } %>
                                        </div>
                                        </td>
                                        </tr>
                                        <% } %>
                                    </tbody>
                                </table>

                                <div class="modal fade" id="addEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel"><%= __("planning.addemployee") %></h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div id="modal-employees-list">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <script>
                                $(document).ready(function() {
                                    $("a.add-employee").click(function() {
                                        var slotId = $(this).parent().parent().attr('data-slotId');
                                        var dateId = $(this).parent().parent().attr('data-dateId');
                                        var that = this;

                                        var presentEmployees = [];
                                        $(this).parent().parent().find("p.employee").each(function() {
                                            presentEmployees.push(parseInt($(this).attr("data-employeeId")));
                                        })

                                        console.log(presentEmployees);

                                        $.get('/employee/availabilities/category/<%= planning.categoryId %>/slot/' + slotId + '/' + dateId, function(availabilities) {
                                            $("div#modal-employees-list").empty();
                                            for(var availability of availabilities) {
                                                $("div#modal-employees-list").append(
                                                    '<p>' +
                                                    '<button class="toggle-employee btn btn-sm ' + (presentEmployees.includes(availability.Employee.id) ? "btn-success" : "btn-danger") + '" data-availabilityid="' + availability.id + '">' +
                                                    availability.Employee.firstName + ' ' + availability.Employee.lastName +
                                                    '</button>' +
                                                    '</p>');
                                            }

                                            $('#addEmployeeModal').modal('show');

                                            $("button.toggle-employee").click(function() {
                                                var availabilityId = $(this).attr("data-availabilityid");

                                                toggleEmployee(availabilityId);
                                            });
                                        });


                                    });

                                    function toggleEmployee(availabilityId) {
                                        console.log(availabilityId);

                                        $.post("/planning/<%= planning.id %>/toggle-availability", {
                                            availabilityId: availabilityId
                                        }, function(value) {
                                            console.log(value);
                                        });
                                    }
                                });
                                </script>

                                <%- include ../footer.ejs %>
